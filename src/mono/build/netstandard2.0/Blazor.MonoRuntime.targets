<Project>

  <PropertyGroup>
    <PrepareBlazorRuntimeDependsOn>
      $(PrepareBlazorRuntimeDependsOn);
    </PrepareBlazorRuntimeDependsOn>
  </PropertyGroup>


  <Target Name="PrepareBlazorRuntime" DependsOnTargets="$(PrepareBlazorRuntimeDependsOn)" AfterTargets="Build">
    <Message Importance="high" text="Blazor Runtime" />    
  </Target>

  <Target Name="PrepareBlazorOutput" AfterTargets="PrepareBlazorRuntime">
    <ItemGroup>
      <_BlazorRuntimeOutputFolder Include="@(BlazorRuntimeOutputFolder->'$(OutputPath)%(Identity)')" />
    </ItemGroup>
    <PropertyGroup>
      <_BlazorRuntimeAsmjsOutputPath>$(OutputPath)$(BlazorRuntimeAsmjsOutputPath)</_BlazorRuntimeAsmjsOutputPath>
      <_BlazorRuntimeWasmOutputPath>$(OutputPath)$(BlazorRuntimeWasmOutputPath)</_BlazorRuntimeWasmOutputPath>
      <_BlazorRuntimeBclOutputPath>$(OutputPath)$(BlazorRuntimeBclOutputPath)</_BlazorRuntimeBclOutputPath>
      <_BlazorJsOutputPath>$(OutputPath)$(BlazorJsOutputPath)</_BlazorJsOutputPath>      
    </PropertyGroup>
    <Message Importance="high" text="Creating directories @(_BlazorRuntimeOutputFolder)" />
    <Message Importance="high" text="Copying blazor files @(MonoAsmJsFile) to $(_BlazorRuntimeAsmjsOutputPath)" />
    <Message Importance="high" text="Copying blazor files @(MonoWasmFile) to $(_BlazorRuntimeWasmOutputPath)" />
    <Message Importance="high" text="Copying blazor files @(BlazorJsFile) to $(_BlazorJsOutputPath)" />
    <MakeDir Directories="@(BlazorRuntimeOutputFolder)" />
    <Copy SourceFiles="@(MonoAsmjsFile)" DestinationFolder="$(BlazorRuntimeAsmjsOutputPath)" />
    <Copy SourceFiles="@(MonoWasmFile)" DestinationFolder="$(BlazorRuntimeWasmOutputPath)" />
    <Copy SourceFiles="@(BlazorJsFile)" DestinationFolder="$(_BlazorJsOutputPath)" />
  </Target>

  <Target Name="RunLinker" AfterTargets="PrepareBlazorRuntime">
    <PropertyGroup>
      <LinkerOutputPath>$(OutputPath)$(BlazorRuntimeBclOutputPath)</LinkerOutputPath>
    </PropertyGroup>
    <ItemGroup>
      <AssembliesToLink Include="@(ReferenceCopyLocalPaths->WithMetadataValue('Extension','.dll')->'-a %(Identity)')" />
      <AssembliesToLink Include="@(MainAssembly->'-a %(FullPath)')" />
      <FolderLookupPaths Include="@(MonoBaseClassLibraryFolder->'-d %(Identity)')" />
    </ItemGroup>
    <Message Importance="high" text="Assemblies to link: @(AssembliesToLink, ' ')" />
    <Message Importance="high" text="dotnet $(MonoLinkerPath) $(AdditionalMonoLinkerOptions) @(FolderLookupPaths, ' ') -o $(LinkerOutputPath) @(AssembliesToLink, ' ')" />
    <Exec Command="dotnet $(MonoLinkerPath) $(AdditionalMonoLinkerOptions) @(FolderLookupPaths, ' ') -o $(LinkerOutputPath) @(AssembliesToLink, ' ')" />
  </Target>

</Project>